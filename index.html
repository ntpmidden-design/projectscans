<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NTP Xgrid – Projectlinks</title>
  <meta name="description" content="Eenvoudige pagina om links naar Xgrid-projecten te delen." />
  <link rel="icon" href="Logo_NTP.png" />

  <!-- UI / Kaart libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; background:#0b1220; color:#eef4f8; }
    h1,h2 { color:#e9f7ff; }
    .wrap { max-width: 72rem; margin: 0 auto; padding: 1rem; }
    .card { background:rgba(255,255,255,0.06); padding:1rem; border-radius:1rem; margin:0.5rem; border:1px solid rgba(255,255,255,0.08); }
    .btn { background:#00AEEF22; border:1px solid #00AEEF55; padding:0.35rem 0.7rem; border-radius:0.5rem; cursor:pointer; }
    .btn:hover { background:#00AEEF44; }
    .qr { width:60px; height:60px; }
    #map-wrapper { display:flex; justify-content:center; margin:5rem auto 2rem auto; }
    #map { width:600px; height:600px; border-radius:16px; box-shadow:0 0 15px rgba(0,174,239,0.3); overflow:hidden; border:1px solid rgba(0,174,239,0.35); background:#0b1220; }
    .muted { color:#9DB3C7; }
    /* Fix voor Tailwind die Leaflet-tiles schaalde */
    .leaflet-container img { max-width: none !important; max-height: none !important; }
    .leaflet-container .leaflet-tile { max-width: none !important; }
  </style>
</head>
<body>
  <h1 class="text-2xl font-bold p-4 text-center">NTP Xgrid – Projectlinks</h1>

  <div class="wrap">
    <div id="projects" class="grid grid-cols-1 md:grid-cols-2"></div>
  </div>

  <h2 class="text-xl font-semibold text-center mt-16">Projecten op de kaart</h2>
  <div id="map-wrapper">
    <div id="map" role="region" aria-label="Projectenkaart"></div>
  </div>

  <script>
  (function(){
    // ---- Data ----
    const links = [
      { id: "nijkerk-depot", title: "Nijkerk – Depot", url: "https://lcc-viewer.xgrids.com/pub/dbmahu-depot_nijkerk", lat: 52.2236767, lng: 5.4610231 },
      { id: "westervoort", title: "Westervoort", url: "https://lcc-viewer.xgrids.com/pub/dbmahu-westervoort", lat: 51.9626715, lng: 5.9669338 },
      { id: "huizen-1", title: "Huizen – Stadenlande 1", url: "https://lcc-viewer.xgrids.com/pub/dbmahu-huizen_stadenlande_1", lat: 52.2939495, lng: 5.2532121 },
      { id: "huizen-2", title: "Huizen – Stadenlande 2", url: "https://lcc-viewer.xgrids.com/pub/dbmahu-huizen_stadenlande_2", lat: 52.2883596, lng: 5.2535263 },
      { id: "doetinchem-1", title: "Doetinchem – 1", url: "https://lcc-viewer.xgrids.com/pub/dbmahu-doetinchem_1", lat: 51.9595997, lng: 6.2990643 }
    ];

    // ---- Globals ----
    let map = null;
    const markersById = {};
    let markersReady = false;

    function focusMarker(id){
      if (!markersReady || !map) {
        const frame = document.getElementById('map-wrapper');
        if (frame && frame.scrollIntoView) frame.scrollIntoView({ behavior:'smooth', block:'center' });
        return;
      }
      const m = markersById[id];
      if (m) {
        map.setView(m.getLatLng(), 13);
        if (m.openPopup) m.openPopup();
        // Extra zichtbaar punt op het gekozen project
        L.circleMarker(m.getLatLng(), { radius: 6, color: '#00AEEF', weight: 2, fillColor: '#00AEEF', fillOpacity: 0.85 })
          .addTo(map).bindPopup('Gekozen project');
      }
    }
    window.focusMarker = focusMarker;

    function renderProjects(){
      const listEl = document.getElementById('projects');
      listEl.innerHTML = '';
      links.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        const qrId = `qr-${p.id}`;
        card.innerHTML = `
          <h3 class='font-semibold'>${p.title}</h3>
          <div class='mt-2 flex gap-2 items-center'>
            <a href='${p.url}' target='_blank' rel='noopener noreferrer' class='btn'>Openen</a>
            <button class='btn' onclick='focusMarker("${p.id}")'>Toon op kaart</button>
            <canvas id='${qrId}' class='qr'></canvas>
          </div>`;
        listEl.appendChild(card);

        try {
          new QRious({ element: document.getElementById(qrId), value: p.url, size: 60, background: 'transparent', foreground: '#00AEEF' });
        } catch(qrErr) {
          console.warn('QR aanmaak mislukt voor', p.id, qrErr);
        }
      });
    }

    function initMap(){
      if (typeof L === 'undefined') {
        const el = document.getElementById('map');
        if (el) el.innerHTML = '<div class="p-4 text-center muted">Kon de interactieve kaart niet laden. Online werkt dit wel.</div>';
        return;
      }
      map = L.map('map', {
        preferCanvas: true,
        worldCopyJump: false,
        updateWhenZooming: true,
        updateWhenMoving: true,
        wheelDebounceTime: 16,
        zoomSnap: 0.25,
        zoomDelta: 0.25,
        fadeAnimation: true,
        zoomAnimation: true,
        keepBuffer: 20
      }).setView([52.15, 5.3], 8);
      // Zorg dat Leaflet de containermaat correct meet na renderen
      setTimeout(() => { try { map.invalidateSize(); } catch(e){} }, 0);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        continuousWorld: true,
        noWrap: false,
        attribution: '&copy; OpenStreetMap',
        updateWhenZooming: true,
        updateWhenIdle: false,
        keepBuffer: 20,
        crossOrigin: true,
        detectRetina: true
      }).addTo(map);

      // Forceer zichtbare marker-iconen (CDN-paden); voorkomt missende default iconen
      const defaultIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      links.forEach(p => {
        if (p.lat && p.lng){
          const marker = L.marker([p.lat, p.lng], { icon: defaultIcon }).addTo(map)
            .bindPopup(`<b>${p.title}</b><br><a href='${p.url}' target='_blank' rel='noopener noreferrer'>Open project</a>`);
          markersById[p.id] = marker;
        }
      });
      markersReady = true;

      // Extra markers blijvend neerzetten bij inzoomen
      map.on('zoomend', () => {
        const c = map.getCenter();
        L.circleMarker(c, { radius: 6, color: '#00AEEF', weight: 2, fillColor: '#00AEEF', fillOpacity: 0.85 })
          .addTo(map).bindPopup('Zoom-centrum');
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderProjects();
      initMap();
    });
  })();
  </script>
</body>
</html>
